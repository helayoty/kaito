name: Push image to ACR
on:
  workflow_run:
    workflows: [ "Create, Scan and Publish KAITO image" ]
    types: [ completed ]

permissions:
  contents: write
  packages: write

env:
  REGISTRY: ghcr.io
  GO_VERSION: '1.20'
  IMAGE_NAME: 'workspace'
  KAITO_MCR_REGISTRY: 'ghcr.io/helayoty/kaito'

jobs:
  build-publish-mcr-image:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    environment: publish-mcr
    outputs:
      tag: ${{ steps.get-tag.outputs.release-tag }}
    steps:
    - name: Set up Go ${{ env.GO_VERSION }}
      uses: actions/setup-go@v5
      with:
        go-version: ${{ env.GO_VERSION  }}

    - id: get-tag
      name: Get tag
      run: |
        echo "release-tag=$(echo ${{ github.event.pull_request.head.ref }} | tr -d release-)" >> $GITHUB_OUTPUT

     - name: Set Image tag
      run: |
        ver=${{ steps.get-tag.outputs.release-tag }}
        echo "IMG_TAG=${ver#"v"}" >> $GITHUB_ENV

    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: true
        ref: ${{ steps.get-tag.outputs.release-tag }}
        
    - name: Login to ${{ env.REGISTRY }}
      uses: docker/login-action@343f7c4344506bcbf9b4de18042ae17996df046d
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: 'Build Image'
      run: |
        OUTPUT_TYPE=type=registry make docker-build-kaito
      env:
        VERSION: ${{ env.IMG_TAG }}
        REGISTRY: ${{ env.KAITO_MCR_REGISTRY }}/public/aks/kaito

    # - name: Authenticate to ACR
    #   run: |
    #     az login --identity
    #     az acr login -n ${{ secrets.KAITO_MCR_REGISTRY }}

    # - name: 'Publish to ACR'
    #   id: Publish
    #   run: |
    #     OUTPUT_TYPE=type=registry make docker-build-kaito
    #   env:
    #     VERSION: ${{ steps.get-tag.outputs.release-tag }}
    #     REGISTRY: ${{ secrets.KAITO_MCR_REGISTRY }}/public/aks/kaito

  run-e2e-mcr:
    permissions:
      contents: read
      id-token: write
      statuses: write
    environment: publish-mcr
    needs: [ check-tag, build-publish-mcr-image ]
    uses: ./.github/workflows/e2e-workflow.yml
    with:
      git_sha: ${{ github.sha }}
      isRelease: true
      registry:  ghcr.io/helayoty/kaito/public/aks/kaito
      tag: ${{ steps.get-tag.outputs.release-tag }}
    secrets:
      E2E_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      E2E_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      E2E_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      E2E_AMRT_SECRET_NAME: ${{ secrets.AMRT_SECRET_NAME }}
      E2E_ACR_AMRT_USERNAME: ${{ secrets.ACR_AMRT_USERNAME }}
      E2E_ACR_AMRT_PASSWORD: ${{ secrets.ACR_AMRT_PASSWORD }}

 create-release:
    runs-on: ubuntu-latest
    environment: publish-mcr
    needs: [ run-e2e-mcr ]
    steps:
      - name: 'Dispatch release tag'
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          event-type: create-release
          client-payload: '{"tag": "v${{ env.IMG_TAG }}"}'
